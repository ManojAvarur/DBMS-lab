CREATE DATABASE COMPANY;

USE COMPANY;

CREATE TABLE DEPARTMENT (
    DEPARTMENT_NO VARCHAR(20) PRIMARY KEY,
    DEPATMENT_NAME VARCHAR(20),
    MGR_START_DATE DATE
);

CREATE TABLE EMPLOYEE (
    SSN VARCHAR(20) PRIMARY KEY,
    FNAME VARCHAR(20),
    LNAME VARCHAR(20),
    ADDRESS VARCHAR(20),
    SEX CHAR(2),
    SALARY INT,
    SUPERSSN VARCHAR(20) REFERENCES EMPLOYEE(SSN),
    DNO VARCHAR(20) REFERENCES DEPARTMENT (DEPARTMENT_NO)
);

ALTER TABLE DEPARTMENT ADD MGR_SSN VARCHAR(20) REFERENCES EMPLOYEE(SSN);

CREATE TABLE DLOCATION (
    DEPARTMENT_LOCATION VARCHAR(20),
    DEPARTMENT_NO VARCHAR(20) REFERENCES DEPARTMENT(DEPARTMENT_NO),
    PRIMARY KEY(DEPARTMENT_NO, DEPARTMENT_LOCATION) 
);

CREATE TABLE PROJECT (
    PNO VARCHAR(20) PRIMARY KEY,
    PNAME VARCHAR(20),
    PLOCATION VARCHAR(20),
    DEPARTMENT_NO VARCHAR(20) REFERENCES DEPARTMENT(DEPARTMENT_NO)
);

CREATE TABLE WORKS_ON (
    HOURS INT(2),
    SSN VARCHAR(20) REFERENCES EMPLOYEE(SSN),
    PNO VARCHAR(20) REFERENCES PROJECT(PNO),
    PRIMARY KEY(SSN , PNO)
);

INSERT INTO EMPLOYEE (SSN, FNAME, LNAME, ADDRESS, SEX, SALARY) VALUES
('RNSECE01','JOHN','SCOTT','BANGALORE','M', 450000),
('RNSCSE01','JAMES','SMITH','BANGALORE','M', 500000),
('RNSCSE02','HEARN','BAKER','BANGALORE','M', 700000),
('RNSCSE03','EDWARD','SCOTT','MYSORE','M', 500000),
('RNSCSE04','PAVAN','HEGDE','MANGALORE','M', 650000),
('RNSCSE05','GIRISH','MALYA','MYSORE','M', 450000),
('RNSCSE06','NEHA','SN','BANGALORE','F', 800000),
('RNSACC01','AHANA','K','MANGALORE','F', 350000),
('RNSACC02','SANTHOSH','KUMAR','MANGALORE','M', 300000),
('RNSISE01','VEENA','M','MYSORE','M', 600000),
('RNSIT01','NAGESH','HR','BANGALORE','M', 500000);

INSERT INTO DEPARTMENT VALUES ('1','ACCOUNTS','2001-01-01','RNSACC02'),
('2','IT','2016-08-01','RNSIT01'),
('3','ECE','2008-06-01','RNSECE01'),
('4','ISE','2015-08-01','RNSISE01'),
('5','CSE','2002-06-01','RNSCSE05');

UPDATE EMPLOYEE SET SUPERSSN=NULL, DNO='3' WHERE SSN='RNSECE01';

UPDATE EMPLOYEE SET SUPERSSN='RNSCSE02', DNO='5' WHERE SSN='RNSCSE01';

UPDATE EMPLOYEE SET SUPERSSN='RNSCSE03', DNO='5' WHERE SSN='RNSCSE02';

UPDATE EMPLOYEE SET SUPERSSN='RNSCSE04', DNO='5' WHERE SSN='RNSCSE03';

UPDATE EMPLOYEE SET DNO='5', SUPERSSN='RNSCSE05' WHERE SSN='RNSCSE04';

UPDATE EMPLOYEE SET DNO='5', SUPERSSN='RNSCSE06' WHERE SSN='RNSCSE05';

UPDATE EMPLOYEE SET DNO='5', SUPERSSN=NULL WHERE SSN='RNSCSE06';

UPDATE EMPLOYEE SET DNO='1', SUPERSSN='RNSACC02' WHERE SSN='RNSACC01';

UPDATE EMPLOYEE SET DNO='1', SUPERSSN=NULL WHERE SSN='RNSACC02';

UPDATE EMPLOYEE SET DNO='4', SUPERSSN=NULL WHERE SSN='RNSISE01';

UPDATE EMPLOYEE SET DNO='2', SUPERSSN=NULL WHERE SSN='RNSIT01';

INSERT INTO DLOCATION VALUES ('BANGALORE', '1'),
('BANGALORE', '2'),
('BANGALORE', '3'),
('MANGALORE', '4'),
('MANGALORE', '5');

INSERT INTO PROJECT VALUES (100,'IOT','BANGALORE','5'),
(101,'CLOUD','BANGALORE','5'),
(102,'BIGDATA','BANGALORE','5'),
(103,'SENSORS','BANGALORE','3'),
(104,'BANK MANAGEMENT','BANGALORE','1'),
(105,'SALARY MANAGEMENT','BANGALORE','1'),
(106,'OPENSTACK','BANGALORE','4'),
(107,'SMART CITY','BANGALORE','2');

INSERT INTO WORKS_ON VALUES (4, 'RNSCSE01', 100),
(6, 'RNSCSE01', 101),
(8, 'RNSCSE01', 102),
(10, 'RNSCSE02', 100),
(3, 'RNSCSE04', 100),
(4, 'RNSCSE05', 101),
(5, 'RNSCSE06', 102),
(6, 'RNSCSE03', 102),
(7, 'RNSECE01', 103),
(5, 'RNSACC01', 104),
(6, 'RNSACC02', 105),
(4, 'RNSISE01', 106),
(10, 'RNSIT01', 107);

-- QUERIES

-- 1>   Make a list of all project numbers for projects that involve an employee whose last
--      name is ‘Scott’, either as a worker or as a manager of the department that controls
--      the project.

(SELECT P.PNO 
    FROM PROJECT P, DEPARTMENT W, EMPLOYEE E
        WHERE E.SSN = W.MGR_SSN AND
                    E.LNAME = 'SCOTT')
UNION
(SELECT P1.PNO 
    FROM PROJECT P1, WORKS_ON W1, EMPLOYEE E1
        WHERE E1.SSN = W1.SSN AND
                P1.PNO = W1.PNO AND
                 E1.LNAME = 'SCOTT' );

-- 2>   Show the resulting salaries if every employee working on the ‘IoT’ project is given a
--      10 percent raise.

SELECT E.SSN, E.FNAME, E.SALARY, '->', (1.1*E.SALARY) AS CURRENT_SALARY
    FROM EMPLOYEE E, PROJECT P, WORKS_ON W
        WHERE E.SSN = W.SSN AND
                P.PNO = W.PNO AND
                    P.PNAME = 'IOT';

-- 3>   Find the sum of the salaries of all employees of the ‘Accounts’ department, as well
--      as the maximum salary, the minimum salary, and the average salary in this
--      department

SELECT SUM(E.SALARY), AVG(E.SALARY), MAX(E.SALARY), MIN(E.SALARY)
    FROM EMPLOYEE E, DEPARTMENT D
        WHERE D.DEPARTMENT_NO = E.DNO AND
                D.DEPATMENT_NAME = 'ACCOUNTS';

-- 4>   Retrieve the name of each employee who works on all the projects controlled by
--      department number 5 (use NOT EXISTS operator).

-- NOT WORKING IN XAMPP

SELECT E.FNAME, E.LNAME 
    FROM EMPLOYEE E
        WHERE NOT EXISTS ((SELECT P.PNO 
                            FROM PROJECT P
                                WHERE DEPARTMENT_NO = '5') NOT IN (SELECT W.PNO
                                                            FROM WORKS_ON W
                                                                WHERE W.SSN = E.SSN AND
                                                                        DEPARTMENT_NO = '5'));

-- 5>   For each department that has
--      more than five employees, retrieve the department number and the number of its
--      employees who are making more than Rs. 6,00,000.

SELECT D.DEPARTMENT_NO, COUNT(*)
    FROM DEPARTMENT D, EMPLOYEE E
        WHERE D.DEPARTMENT_NO = E.DNO
            AND E.SALARY > 600000
            AND D.DEPARTMENT_NO IN (SELECT E1.DNO
                                        FROM EMPLOYEE E1
                                            GROUP BY E1.DNO
                                                HAVING COUNT(DNO)>5)
            GROUP BY D.DEPARTMENT_NO;