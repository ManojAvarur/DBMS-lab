CREATE TABLE SALESMAN (
    SALESMAN_ID VARCHAR(20) PRIMARY KEY,
    SALESMAN_NAME VARCHAR(20),
    CITY VARCHAR(30),
    COMMISSION VARCHAR(20) 
);

CREATE TABLE CUSTOMER (
    CUSTOMER_ID VARCHAR(20) PRIMARY KEY,
    CUSTOMER_NAME VARCHAR(20),
    CUSTOMER_CITY VARCHAR(20),
    GRADE VARCHAR(20),
    SALESMAN_ID VARCHAR(20) REFERENCES SALESMAN (SALESMAN_ID) ON DELETE SET NULL
);

CREATE TABLE ORDERS (
    ORD_NO VARCHAR(20) PRIMARY KEY,
    PURCHASE_AMT INT,
    ORDER_DATE DATE,
    CUSTOMER_ID VARCHAR(20) REFERENCES CUSTOMER(CUSTOMER_ID) ON DELETE SET NULL,
    SALESMAN_ID VARCHAR(20) REFERENCES SALESMAN (SALESMAN_ID) ON DELETE SET NULL
);


INSERT INTO SALESMAN VALUES ('S1000','PRANAV','BANGALORE','45%'),
('S2000','KIRAN','MYSORE','35%'),
('S3000','JAYANTH','MANGALORE','10%'),
('S4000','SHREYAS','CHENNAI','5%'),
('S5000','AKASH','HYDERBAD','55%');

INSERT INTO CUSTOMER VALUES ('C1000','MANOJ A M','BANGALORE','100','S1000'),
('C2000','KEERTHANA R','MANGALORE','300','S2000'),
('C3000','SINDHU P','CHENNAI','400','S3000'),
('C4000','SONU R S','MYSORE','500','S3000'),
('C5000','MADHUSUDHAN T','BANGALORE','600','S1000'),
('C6000','SONU R S','DELHI','700','S4000'),
('C7000','PARI V','MUMBAI','800','S5000'),
('C8000','NIROOP','PUNJAB','700','S1000'),
('C9000','ANOOP','JAMMU & KASHMIR','900','S5000');

INSERT INTO ORDERS VALUES ('O1000','100000','2017-01-01','C1000','S1000'),
('O2000','90000','2017-02-02','C2000','S2000'),
('O3000','80000','2017-03-03','C3000','S3000'),
('O4000','70000','2017-04-04','C4000','S4000'),
('O5000','60000','2017-05-05','C5000','S5000'),
('O6000','50000','2017-06-06','C1000','S5000'),
('O7000','40000','2017-07-07','C2000','S4000'),
('O8000','30000','2017-08-08','C3000','S2000'),
('O9000','20000','2017-09-09','C4000','S3000');


-- QUERIES

-- 1> Count the customers with grades above Bangalore’s average.

SELECT GRADE, COUNT(DISTINCT CUSTOMER_ID)
    FROM CUSTOMER
        GROUP BY GRADE
            HAVING GRADE > (SELECT AVG(GRADE) 
                                FROM CUSTOMER
                                    WHERE CUSTOMER_CITY = 'BANGALORE');

-- 2>   Find the name and numbers of all salesmen who had more than one customer.

    SELECT S.SALESMAN_NAME, S.SALESMAN_ID
        FROM SALESMAN S
            WHERE 1 < (SELECT COUNT(*)
                            FROM CUSTOMER C
                                WHERE C.SALESMAN_ID = S.SALESMAN_ID);

 --   (OR)

    SELECT S.SALESMAN_NAME, S.SALESMAN_ID
        FROM SALESMAN S, CUSTOMER C
            WHERE C.SALESMAN_ID = S.SALESMAN_ID
                GROUP BY SALESMAN_ID
                    HAVING COUNT(C.SALESMAN_ID) > 1;


-- 3> List all salesmen and indicate those who have and don’t have customers in their cities (Use UNION operation.)

SELECT SALESMAN.SALESMAN_ID, SALESMAN.SALESMAN_NAME, CUSTOMER.CUSTOMER_NAME
    FROM SALESMAN, CUSTOMER
        WHERE SALESMAN.CITY = CUSTOMER.CUSTOMER_CITY
UNION
SELECT SALESMAN_ID, SALESMAN_NAME, 'NO_MATCH'
    FROM SALESMAN
        WHERE  NOT CITY = ANY (SELECT CUSTOMER_CITY FROM CUSTOMER) 
ORDER BY 2 DESC;

-- 4> Create a view that finds the salesman who has the customer with the highest order of a day.

CREATE VIEW ELIGHT_SALESMAN AS
    SELECT O.ORDER_DATE, S.SALESMAN_ID, S.SALESMAN_NAME
        FROM ORDERS O, SALESMAN S
            WHERE S.SALESMAN_ID = O.SALESMAN_ID AND
                PURCHASE_AMT = (SELECT MAX(PURCHASE_AMT)
                                    FROM ORDERS 
                                        WHERE O.ORDER_DATE = ORDER_DATE);

-- 5> Demonstrate the DELETE operation by removing salesman with id 1000. All his orders
--      must also be deleted.

DELETE FROM SALESMAN
    WHERE SALESMAN_ID = 'S1000';