CREATE DATABASE LIBRARY_Database;

USE LIBRARY_Database;

CREATE TABLE PUBLISHER (
    PUBLISHER_NAME VARCHAR(20) PRIMARY KEY,
    PHONE_NUMBER INTEGER(10),
    ADDRESS VARCHAR(20)
);

CREATE TABLE BOOK (
    BOOK_ID INT PRIMARY KEY,
    TITLE VARCHAR(20),
    PUBLISH_YEAR DATE,
    PUBLISHER_NAME VARCHAR(20) REFERENCES PUBLISHER (PUBLISHER_NAME) ON DELETE CASCADE
);


CREATE TABLE BOOK_AUTHORS (
    BOOK_ID INT PRIMARY KEY REFERENCES BOOK (BOOK_ID) ON DELETE CASCADE,
    AUTHOR_NAME VARCHAR(20)
);

CREATE TABLE LIBRARY_BRANCH (
    BRANCH_ID INT PRIMARY KEY,
    ADDRESS VARCHAR(20),
    BRANCH_NAME VARCHAR(20)
);

CREATE TABLE BOOK_COPIES (
    BOOK_ID INT REFERENCES BOOK (BOOK_ID) ON DELETE CASCADE,
    BRANCH_ID INT REFERENCES LIBRARY_BRANCH (BRANCH_ID) ON DELETE CASCADE,
    NO_OF_COPIES INT,
    PRIMARY KEY( BOOK_ID, BRANCH_ID)
);


CREATE TABLE BOOK_LEANDING (
    BOOK_ID INT REFERENCES BOOK (BOOK_ID) ON DELETE CASCADE,
    BRANCH_ID INT REFERENCES LIBRARY_BRANCH (BRANCH_ID) ON DELETE CASCADE,
    CARD_NO INT,
    DATE_OUT DATE,
    DUE_DATE DATE,
    PRIMARY KEY( BOOK_ID, BRANCH_ID, CARD_NO)
);

INSERT INTO PUBLISHER VALUES ('MANOJ A M', 9538163398, 'SRINAGAR BANGALORE'),
('KEERTHANA R',123456789, 'VIJAYNAGAR BANGALORE'),
('SINDHU P', 987654321, 'SRINAGAR BANGALORE'),
('SHREYAS S', 123456789, 'RAGHAVENDRA BLOCK BANGALORE'),
('PRANAV UDUPA', 987654321, 'RAGHAVENDRA BANGALORE');

INSERT INTO BOOK VALUES (1000, 'MASTERS IN CS', '2017-01-02', 'MANOJ A M'),
(1001, 'LEARN AUTOMETA THEROY', '2017-02-04', 'KEERTHANA R'),
(1002, 'LEARN TO LIE', '2017-03-06', 'SINDHU P'),
(1003, 'DONT ACT STUPIED', '2017-06-10', 'SHREYAS S'),
(1004, 'LEARN TO RIDE LIKE A PRO', '2017-01-12', 'PRANAV UDUPA');

INSERT INTO BOOK_AUTHORS VALUES (1000,'MANOJ'),
(1001,'KEERTHANA'),
(1002,'SINDHU'),
(1003,'SHREYAS'),
(1004,'PRANAV');

INSERT INTO LIBRARY_BRANCH VALUES (5000, 'SRINAGAR BANGALORE', 'PULSAR NS200'),
(5001, 'VIJAYNAGAR BANGALORE', 'HUNDAI CREATA'),
(5002, 'SRINAGAR BANGALORE', 'HONDA ACTIVA'),
(5003, 'RAGHAVENDRA BLOCK BANGALORE' ,'APACHE RTR200'),
(5004, 'RAGHAVENDRA BANGALORE', 'DUKE 390');

INSERT INTO BOOK_COPIES VALUES (1000, 5000, 100),
(1001, 5001, 90),
(1002, 5002, 80),
(1003, 5003, 70),
(1004, 5004, 60);


INSERT INTO BOOK_LEANDING VALUES (1000, 5000, 2000, '2017-01-02', '2017-02-04'),
(1001, 5001, 2001, '2017-02-04','2017-01-02'),
(1002, 5002, 2002, '2017-03-06', '2017-01-10'),
(1003, 5003, 2003, '2017-01-10', '2017-03-06'),
(1004, 5004, 2004, '2017-01-12', '2017-02-04'),
(1001, 5001, 2002, '2017-02-04', '2017-01-02'),
(1003, 5003, 2002, '2017-01-10', '2017-03-06'),
(1004, 5004, 2002, '2017-01-12', '2017-02-04');

--- INSERT INTO BOOK_LEANDING (BOOK_ID, BRANCH_ID, CARD_NO, DATE_OUT, DUE_DATE) VALUES (?,?,?,?,?);
--- ALTER TABLE `book_leanding` CHANGE `DUE_DATE` `DUE_DATE` DATE NOT NULL;

--- QUERIES ---

--   1>  Retrieve details of all books in the library â€“ id, title, name of publisher, authors,
--       number of copies in each branch, etc.

SELECT B.*, BC.NO_OF_COPIES
    FROM BOOK B, BOOK_COPIES BC, LIBRARY_BRANCH LB
        WHERE B.BOOK_ID = BC.BOOK_ID AND
            LB.BRANCH_ID = BC.BRANCH_ID;


-- 2>   Get the particulars of borrowers who have borrowed more than 3 books, but from Jan
--      2017 to Jun 2017

SELECT CARD_NO
    FROM BOOK_LEANDING BL
        WHERE DATE_OUT BETWEEN '2017-01-01' AND '2017-06-01'
            GROUP BY CARD_NO
                HAVING COUNT(*) > 3 ;


-- 3>   Partition the BOOK table based on year of publication. Demonstrate its working with a
--      SIMPLE query.

CREATE VIEW PARTITION_EXAMPLE AS
    SELECT PUBLISH_YEAR
        FROM BOOK;


-- 4>   Create a view of all books and its number of copies that are currently available in the
--      Library

CREATE VIEW BOOK_IN_LIBRARY AS
    SELECT BC.BOOK_ID, BC.BRANCH_ID, BC.NO_OF_COPIES, LB.BRANCH_NAME, LB.ADDRESS
        FROM LIBRARY_BRANCH LB, BOOK_COPIES BC
            WHERE BC.BRANCH_ID = LB.BRANCH_ID;

-- 5>   Delete a book in BOOK table. Update the contents of other tables to reflect this data
--      manipulation operation.

DELETE FROM BOOK 
    WHERE BOOK_ID = 1003;

-- TRY

CREATE VIEW BOOK_IN_LIBRARY_CHECK AS
    SELECT BC.BOOK_ID, BC.BRANCH_ID, BC.NO_OF_COPIES, LB.BRANCH_NAME, LB.ADDRESS
        FROM LIBRARY_BRANCH LB, BOOK_COPIES BC
            WHERE BC.BRANCH_ID = LB.BRANCH_ID AND
            LB.BRANCH_ID = 5000 ;



